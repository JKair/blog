---
title: 一个关于session奇怪的BUG
date: 2015.12.31 23:14:17
tags: [php]
categories: 后端
---

1. 环境如下：
thinkphp + PHP5.4 + apache + mysql + linux/windows.

1. bug描述如下：
当我页面进行登录的时候，一开始登录上去了，然后隔一段时间，突然间就又自动退出了，而且退出的session返回之前的状态，很难寻找究竟BUG出现在哪里。

1. 解决过程如下：

 - 首先，和同事尽力地去重现这个BUG，但是发现这个BUG是不定时出现的，刷着刷着就出现了，很奇怪问题究竟出现在什么地方，于是就无限重复地尝试重试BUG，总结了这个BUG的规律大概就是，隔一段时间，就自动刷新回以前的session。
 - 之后无限重读了thinkphp的源码，发现问题并不大，怎么思考都觉得没有这方面的BUG。
 - 回忆了这几天所做的修改，发现最大的就是把session存进数据库，还有就是新版页面的轮询。于是翻查了数据库的东西，发现并没有存在这些问题，无论如何都是在我打开登录页面，登录之后，刷新回某个页面发生的事情。
  - 在同事的提醒下，突然间明白了整个BUG的产生过程。

1. BUG发生的原因解析：
 - 我在其他页面使用了轮询，这是一个单独的线程，然而session的机制，当我关闭这个线程的时候，PHP会将当前session重新写入，这样就导致了，虽然我已经登录了，但是由于轮询的那个线程关闭时间还没到，当时间一到，线程关闭，session被重新写入，session被我无意中删除！

1. 解决方案：
 - 在轮询的过程中，不需要写入session的话，则session_write_close()
 - 当你需要写入session，再session_start()


这个BUG非常之无脑= =，两个人合作查找了一两个小时，不过问题最终还是解决完毕了。记录一下。